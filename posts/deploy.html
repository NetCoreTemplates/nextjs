<!DOCTYPE html><html lang="en"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png"/><link rel="manifest" href="/favicon/site.webmanifest"/><link rel="mask-icon" href="/favicon/safari-pinned-tab.svg" color="#000000"/><link rel="shortcut icon" href="/favicon/favicon.ico"/><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-config" content="/favicon/browserconfig.xml"/><meta name="theme-color" content="#000"/><link rel="alternate" type="application/rss+xml" href="/feed.xml"/><meta name="description" content="A statically generated blog example using Next.js and Markdown."/><meta property="og:image" content="https://og-image.vercel.app/Next.js%20Blog%20Starter%20Example.png?theme=light&amp;md=1&amp;fontSize=100px&amp;images=https%3A%2F%2Fassets.vercel.com%2Fimage%2Fupload%2Ffront%2Fassets%2Fdesign%2Fnextjs-black-logo.svg"/><title>Deployment with GitHub Actions | Next.js Example with Markdown</title><meta property="og:image" content="/assets/blog/dynamic-routing/cover.jpg"/><meta name="next-head-count" content="16"/><link rel="preload" href="/_next/static/css/7b3b590ea2191db8.css" as="style"/><link rel="stylesheet" href="/_next/static/css/7b3b590ea2191db8.css" data-n-g=""/><link rel="preload" href="/_next/static/css/e1f6961df2961232.css" as="style"/><link rel="stylesheet" href="/_next/static/css/e1f6961df2961232.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-2b99834efceef160.js" defer=""></script><script src="/_next/static/chunks/framework-91d7f78b5b4003c8.js" defer=""></script><script src="/_next/static/chunks/main-eab312c0bf2a7270.js" defer=""></script><script src="/_next/static/chunks/pages/_app-4ed993e260c0beb6.js" defer=""></script><script src="/_next/static/chunks/80-15bcadb274618f95.js" defer=""></script><script src="/_next/static/chunks/9-0a69b3d0dfbb78f5.js" defer=""></script><script src="/_next/static/chunks/398-9f83417d24e48f8f.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-70494c6693593606.js" defer=""></script><script src="/_next/static/4l-1YYj4UL_dqsszTxfpO/_buildManifest.js" defer=""></script><script src="/_next/static/4l-1YYj4UL_dqsszTxfpO/_ssgManifest.js" defer=""></script><script src="/_next/static/4l-1YYj4UL_dqsszTxfpO/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><header class="border-b border-gray-200 pr-3"><div class="flex flex-wrap items-center"><div class="flex-shrink flex-grow-0"><div class="p-4 cursor-pointer"><img class="w-8 h-8" src="/assets/img/logo.svg" alt="MyApp logo"/></div></div><div class="flex flex-grow flex-shrink flex-nowrap justify-end items-center"><nav class="relative flex flex-grow"><ul class="flex flex-wrap items-center justify-end w-full m-0"><li class="relative flex flex-wrap just-fu-start m-0"><a class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 m-2" href="/hosting">$0.40 /mo</a></li><li class="relative flex flex-wrap just-fu-start m-0"><a class="flex items-center justify-start mw-full p-4 hover:text-success" href="/posts">Blog</a></li><li class="relative flex flex-wrap just-fu-start m-0"><a class="flex items-center justify-start mw-full p-4 hover:text-success" href="/todomvc">Todos</a></li><li class="relative flex flex-wrap just-fu-start m-0"><a class="flex items-center justify-start mw-full p-4 hover:text-success" href="/bookings-crud">Bookings</a></li><li class="relative flex flex-wrap just-fu-start m-0"><a class="flex items-center justify-start mw-full p-4 hover:text-success" href="/features">Features</a></li><li class="relative flex flex-wrap just-fu-start m-0"><a class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 m-2" href="/signin">Sign In</a></li><li class="relative flex flex-wrap just-fu-start m-0"><a class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 m-2" href="/signup">Register</a></li></ul></nav></div></div></header><div class="min-h-screen"><main><div class="container mx-auto px-5"><h2 class="text-2xl md:text-4xl font-bold tracking-tight md:tracking-tighter leading-tight mb-20 mt-8"><a class="hover:underline" href="/">MyApp</a>.</h2><article class="prose lg:prose-xl max-w-none mb-32"><h1 class="text-6xl md:text-7xl lg:text-8xl font-bold tracking-tighter leading-tight md:leading-none mb-12 text-center md:text-left">Deployment with GitHub Actions</h1><div class="hidden md:block md:mb-12"><div class="flex items-center"><img src="/assets/blog/authors/author1.svg" class="w-12 h-12 rounded-full mr-4" alt="Author"/><div class="text-xl font-bold">Author</div></div></div><div class="mb-8 md:mb-16 sm:mx-0"><div class="sm:mx-0"><img src="/assets/blog/dynamic-routing/cover.jpg" alt="Cover Image for Deployment with GitHub Actions" class="shadow-small"/></div></div><div class="max-w-2xl mx-auto"><div class="block md:hidden mb-6"><div class="flex items-center"><img src="/assets/blog/authors/author1.svg" class="w-12 h-12 rounded-full mr-4" alt="Author"/><div class="text-xl font-bold">Author</div></div></div><div class="mb-6 text-lg"><time dateTime="2021-11-09T05:35:07.322Z">November	9, 2021</time></div></div><div class="max-w-2xl mx-auto"><div class="markdown-styles_markdown__h_8de"><h1>ServiceStack GitHub Action Deployments</h1>
<p>The <a href="https://github.com/NetCoreTemplates/nextjs/blob/main/.github/workflows/release.yml">release.yml</a>
in this template enables GitHub Actions CI deployment to a dedicated server with SSH access.</p>
<h2>Overview</h2>
<p><code>release.yml</code> is designed to work with a ServiceStack app deploying directly to a single server via SSH. A docker image is built and stored on GitHub's <code>ghcr.io</code> docker registry when a GitHub Release is created.</p>
<p>GitHub Actions specified in <code>release.yml</code> then copy files remotely via scp and use <code>docker-compose</code> to run the app remotely via SSH.</p>
<h2>What's the process of <code>release.yml</code>?</h2>
<p><img src="https://raw.githubusercontent.com/ServiceStack/docs/master/docs/images/mix/release-ghr-vanilla-diagram.png" alt=""></p>
<h2>Deployment server setup</h2>
<p>To get this working, a server needs to be setup with the following:</p>
<ul>
<li>SSH access</li>
<li>docker</li>
<li>docker-compose</li>
<li>ports 443 and 80 for web access of your hosted application</li>
</ul>
<p>This can be your own server or any cloud hosted server like Digital Ocean, AWS, Azure etc.</p>
<p>When setting up your server, you'll want to use a dedicated SSH key for access to be used by GitHub Actions. GitHub Actions will need the <em>private</em> SSH key within a GitHub Secret to authenticate. This can be done via ssh-keygen and copying the public key to the authorized clients on the server.</p>
<p>To let your server handle multiple ServiceStack applications and automate the generation and management of TLS certificates, an additional docker-compose file is provided in this template, <code>nginx-proxy-compose.yml</code>. This docker-compose file is ready to run and can be copied to the deployment server.</p>
<p>For example, once copied to remote <code>~/nginx-proxy-compose.yml</code>, the following command can be run on the remote server.</p>
<pre><code>docker-compose -f ~/nginx-proxy-compose.yml up -d
</code></pre>
<p>This will run an nginx reverse proxy along with a companion container that will watch for additional containers in the same docker network and attempt to initialize them with valid TLS certificates.</p>
<h2>GitHub Repository setup</h2>
<p>This template pushes the API server dockerized application to GitHub Container Repository. To do this, you will first need to <a href="https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token">create a Personal Access Token</a> specifically for use by <code>release.yml</code> GitHub Actions.</p>
<p>This token will need to have access to <code>write:packages</code> to the GitHub Package Registry, which includes the GitHub Container Registry.</p>
<p>The first time the <code>release.yml</code> process successfully runs and creates your GitHub Container Repository for your project, you then have the option to <a href="https://docs.github.com/en/packages/managing-github-packages-using-github-actions-workflows/publishing-and-installing-a-package-with-github-actions#upgrading-a-workflow-that-accesses-ghcrio">upgrade the workflow to use GITHUB_TOKEN</a> replacing the <code>CR_PAT</code>.</p>
<h3>GitHub Actions secrets</h3>
<p>The <code>release.yml</code> assumes 5 secrets have been set:</p>
<table>
<thead>
<tr>
<th>Required Secrets</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CR_PAT</code></td>
<td>GitHub Personal Token with read/write access to packages</td>
</tr>
<tr>
<td><code>DEPLOY_API</code></td>
<td>Hostname used to SSH deploy .NET App to, this can either be an IP address or subdomain with A record pointing to the server</td>
</tr>
<tr>
<td><code>DEPLOY_USERNAME</code></td>
<td>Username to log in with via SSH e.g, <strong>ubuntu</strong>, <strong>ec2-user</strong>, <strong>root</strong></td>
</tr>
<tr>
<td><code>DEPLOY_KEY</code></td>
<td>SSH private key used to remotely access deploy .NET App</td>
</tr>
<tr>
<td><code>LETSENCRYPT_EMAIL</code></td>
<td>Email required for Let's Encrypt automated TLS certificates</td>
</tr>
</tbody>
</table>
<p>To also enable deploying static assets to a CDN:</p>
<table>
<thead>
<tr>
<th>Optional Secrets</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>DEPLOY_CDN</code></td>
<td>Hostname where static <strong>/wwwroot</strong> assets should be deployed to</td>
</tr>
</tbody>
</table>
<p>These secrets can use the <a href="https://cli.github.com/manual/gh_secret_set">GitHub CLI</a> for ease of creation. Eg, using the GitHub CLI the following can be set.</p>
<pre><code class="language-bash">gh secret set CR_PAT -b"&#x3C;CR_PAT>"
gh secret set DEPLOY_API -b"&#x3C;DEPLOY_API>"
gh secret set DEPLOY_USERNAME -b"&#x3C;DEPLOY_USERNAME>"
gh secret set DEPLOY_KEY &#x3C; key.pem # DEPLOY_KEY
gh secret set LETSENCRYPT_EMAIL -b"&#x3C;LETSENCRYPT_EMAIL>"
gh secret set DEPLOY_CDN -b"&#x3C;DEPLOY_CDN>"
</code></pre>
<p>These secrets are used to populate variables within GitHub Actions and other configuration files.</p>
<h2>UI Deployment</h2>
<p>The Next.js <code>ui</code> application is built and deployed to GitHub Pages during the <code>release.yml</code> workflow process by committing the result of <code>npm run build</code> to <code>gh-pages</code> branch in the repository.</p>
<p>Variable replacement of <code>$DEPLOY_API</code> and <code>$DEPLOY_CDN</code> is performed on the following files as a way to coordinate configuration between the <code>ui</code> and <code>api</code> project.</p>
<ul>
<li><code>ui/next.config.js</code> - Set backend .NET API URL for UI App to use</li>
<li><code>ui/post.build.js</code> - If exists, run from GitHub Action after <code>npm run build</code></li>
</ul>
<h3>post.build.js</h3>
<p>The <code>post.build.js</code> script helps when also publishing <code>/ui</code> assets to CDN by first copying the generated
<code>index.html</code> home page into <code>404.html</code> in order to enable full page reloads to use SPA client routing:</p>
<pre><code class="language-js">const fs = require("fs")
const path = require("path")

// Replaced in release.yml with GitHub Actions secrets
const DEPLOY_API = 'https://$DEPLOY_API'
const DEPLOY_CDN = 'https://$DEPLOY_CDN'

const DIST = '../api/Jamstacks/wwwroot'

// 404.html SPA fallback (supported by GitHub Pages, Cloudflare &#x26; Netlify CDNs)
fs.copyFileSync(
    path.resolve(`${DIST}/index.html`),
    path.resolve(`${DIST}/404.html`))

// Define Virtual Host for GitHub Pages CDN
fs.writeFileSync(`${DIST}/CNAME`, DEPLOY_CDN)

// Define /api proxy routes (supported by Cloudflare or Netlify CDNs)  
fs.writeFileSync(`${DIST}/_redirects`,
    fs.readFileSync(`${DIST}/_redirects`, 'utf-8')
        .replace(/{DEPLOY_API}/g, DEPLOY_API))
</code></pre>
<p>Whilst the <code>_redirects</code> file is a convention supported by many <a href="https://jamstack.wtf/#deployment">popular Jamstack CDNs</a>
that sets up a new rule that proxies <code>/api*</code> requests to where the production .NET App is deployed to in order
for API requests to not need CORS:</p>
<pre><code>/api/*  {DEPLOY_API}/api/:splat  200
</code></pre>
<p>By default this template doesn't use the <code>/api</code> proxy route &#x26; makes CORS API requests so it can be freely hosted
on GitHub pages CDN.</p>
<h2>Pushing updates and rollbacks</h2>
<p>By default, deployments of both the <code>ui</code> and <code>api</code> occur on commit to your main branch. A new Docker image for your ServiceStack API is produced, pushed to GHCR.io and hosted on your Linux server with Docker Compose.
Your React UI is built and pushed to the repository GitHub Pages.</p>
<p>The template also will run the release process on the creation of a GitHub Release making it easier to switch to manual production releases.</p>
<p>Additionally, the <code>release.yml</code> workflow can be run manually specifying a version. This enables production rollbacks based on previously tagged releases.
A release must have already been created for the rollback build to work, it doesn't create a new Docker build based on previous code state, only redeploys as existing Docker image.</p>
<h2>No CORS Hosting Options</h2>
<p>The <code>CorsFeature</code> needs to be enabled when adopting our recommended deployment configuration of having static
<code>/wwwroot</code> assets hosted from a CDN in order to make cross-domain requests to your .NET APIs.</p>
<h3>Using a CDN Proxy</h3>
<p>Should you want to, our recommended approach to avoid your App making CORS requests is to define an <code>/api</code> proxy route
on your CDN to your <code>$DEPLOY_API</code> server.</p>
<p>To better support this use-case, this template includes populating the <code>_redirects</code> file used by popular CDNs like
<a href="https://developers.cloudflare.com/pages/platform/redirects">Cloudflare proxy redirects</a> and
<a href="https://docs.netlify.com/routing/redirects/rewrites-proxies/#proxy-to-another-service">Netlify proxies</a> to define
redirect and proxy rules. For AWS CloudFront you would need to define a
<a href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/RequestAndResponseBehaviorCustomOrigin.html">Behavior for a custom origin</a>.</p>
<h3>No CDN</h3>
<p>Of course the easiest solution is to not need CORS in the first place by not deploying to a CDN and serving both <code>/api</code>
and UI from your .NET App. But this would forgo all the performance &#x26; UX benefits that has made
<a href="https://jamstack.org">Jamstack</a> approach so popular.</p></div></div></article></div></main></div><footer class="bg-accent-1 border-t border-accent-2"><div class="container mx-auto px-5"><div class="py-28 flex flex-col lg:flex-row items-center"><h3 class="text-4xl lg:text-6xl font-bold tracking-tighter leading-tight text-center lg:text-left mb-10 lg:mb-0 lg:pr-4 lg:w-1/2">A ServiceStack Project</h3><div class="flex flex-col lg:flex-row justify-center items-center lg:pl-4 lg:w-1/2"><a href="https://docs.servicestack.net" class="mx-3 bg-black hover:bg-white hover:text-black border border-black text-white font-bold py-3 px-12 lg:px-8 duration-200 transition-colors mb-6 lg:mb-0">Read Documentation</a><a href="https://github.com/NetCoreTemplates/nextjs" class="mx-3 font-bold hover:underline">View on GitHub</a></div></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"Deployment with GitHub Actions","date":"2021-11-09T05:35:07.322Z","slug":"deploy","author":{"name":"Author","picture":"/assets/blog/authors/author1.svg"},"content":"\u003ch1\u003eServiceStack GitHub Action Deployments\u003c/h1\u003e\n\u003cp\u003eThe \u003ca href=\"https://github.com/NetCoreTemplates/nextjs/blob/main/.github/workflows/release.yml\"\u003erelease.yml\u003c/a\u003e\nin this template enables GitHub Actions CI deployment to a dedicated server with SSH access.\u003c/p\u003e\n\u003ch2\u003eOverview\u003c/h2\u003e\n\u003cp\u003e\u003ccode\u003erelease.yml\u003c/code\u003e is designed to work with a ServiceStack app deploying directly to a single server via SSH. A docker image is built and stored on GitHub's \u003ccode\u003eghcr.io\u003c/code\u003e docker registry when a GitHub Release is created.\u003c/p\u003e\n\u003cp\u003eGitHub Actions specified in \u003ccode\u003erelease.yml\u003c/code\u003e then copy files remotely via scp and use \u003ccode\u003edocker-compose\u003c/code\u003e to run the app remotely via SSH.\u003c/p\u003e\n\u003ch2\u003eWhat's the process of \u003ccode\u003erelease.yml\u003c/code\u003e?\u003c/h2\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/ServiceStack/docs/master/docs/images/mix/release-ghr-vanilla-diagram.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch2\u003eDeployment server setup\u003c/h2\u003e\n\u003cp\u003eTo get this working, a server needs to be setup with the following:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eSSH access\u003c/li\u003e\n\u003cli\u003edocker\u003c/li\u003e\n\u003cli\u003edocker-compose\u003c/li\u003e\n\u003cli\u003eports 443 and 80 for web access of your hosted application\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis can be your own server or any cloud hosted server like Digital Ocean, AWS, Azure etc.\u003c/p\u003e\n\u003cp\u003eWhen setting up your server, you'll want to use a dedicated SSH key for access to be used by GitHub Actions. GitHub Actions will need the \u003cem\u003eprivate\u003c/em\u003e SSH key within a GitHub Secret to authenticate. This can be done via ssh-keygen and copying the public key to the authorized clients on the server.\u003c/p\u003e\n\u003cp\u003eTo let your server handle multiple ServiceStack applications and automate the generation and management of TLS certificates, an additional docker-compose file is provided in this template, \u003ccode\u003enginx-proxy-compose.yml\u003c/code\u003e. This docker-compose file is ready to run and can be copied to the deployment server.\u003c/p\u003e\n\u003cp\u003eFor example, once copied to remote \u003ccode\u003e~/nginx-proxy-compose.yml\u003c/code\u003e, the following command can be run on the remote server.\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003edocker-compose -f ~/nginx-proxy-compose.yml up -d\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis will run an nginx reverse proxy along with a companion container that will watch for additional containers in the same docker network and attempt to initialize them with valid TLS certificates.\u003c/p\u003e\n\u003ch2\u003eGitHub Repository setup\u003c/h2\u003e\n\u003cp\u003eThis template pushes the API server dockerized application to GitHub Container Repository. To do this, you will first need to \u003ca href=\"https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token\"\u003ecreate a Personal Access Token\u003c/a\u003e specifically for use by \u003ccode\u003erelease.yml\u003c/code\u003e GitHub Actions.\u003c/p\u003e\n\u003cp\u003eThis token will need to have access to \u003ccode\u003ewrite:packages\u003c/code\u003e to the GitHub Package Registry, which includes the GitHub Container Registry.\u003c/p\u003e\n\u003cp\u003eThe first time the \u003ccode\u003erelease.yml\u003c/code\u003e process successfully runs and creates your GitHub Container Repository for your project, you then have the option to \u003ca href=\"https://docs.github.com/en/packages/managing-github-packages-using-github-actions-workflows/publishing-and-installing-a-package-with-github-actions#upgrading-a-workflow-that-accesses-ghcrio\"\u003eupgrade the workflow to use GITHUB_TOKEN\u003c/a\u003e replacing the \u003ccode\u003eCR_PAT\u003c/code\u003e.\u003c/p\u003e\n\u003ch3\u003eGitHub Actions secrets\u003c/h3\u003e\n\u003cp\u003eThe \u003ccode\u003erelease.yml\u003c/code\u003e assumes 5 secrets have been set:\u003c/p\u003e\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003eRequired Secrets\u003c/th\u003e\n\u003cth\u003eDescription\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ccode\u003eCR_PAT\u003c/code\u003e\u003c/td\u003e\n\u003ctd\u003eGitHub Personal Token with read/write access to packages\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ccode\u003eDEPLOY_API\u003c/code\u003e\u003c/td\u003e\n\u003ctd\u003eHostname used to SSH deploy .NET App to, this can either be an IP address or subdomain with A record pointing to the server\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ccode\u003eDEPLOY_USERNAME\u003c/code\u003e\u003c/td\u003e\n\u003ctd\u003eUsername to log in with via SSH e.g, \u003cstrong\u003eubuntu\u003c/strong\u003e, \u003cstrong\u003eec2-user\u003c/strong\u003e, \u003cstrong\u003eroot\u003c/strong\u003e\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ccode\u003eDEPLOY_KEY\u003c/code\u003e\u003c/td\u003e\n\u003ctd\u003eSSH private key used to remotely access deploy .NET App\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ccode\u003eLETSENCRYPT_EMAIL\u003c/code\u003e\u003c/td\u003e\n\u003ctd\u003eEmail required for Let's Encrypt automated TLS certificates\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003eTo also enable deploying static assets to a CDN:\u003c/p\u003e\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003eOptional Secrets\u003c/th\u003e\n\u003cth\u003eDescription\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ccode\u003eDEPLOY_CDN\u003c/code\u003e\u003c/td\u003e\n\u003ctd\u003eHostname where static \u003cstrong\u003e/wwwroot\u003c/strong\u003e assets should be deployed to\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003eThese secrets can use the \u003ca href=\"https://cli.github.com/manual/gh_secret_set\"\u003eGitHub CLI\u003c/a\u003e for ease of creation. Eg, using the GitHub CLI the following can be set.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-bash\"\u003egh secret set CR_PAT -b\"\u0026#x3C;CR_PAT\u003e\"\ngh secret set DEPLOY_API -b\"\u0026#x3C;DEPLOY_API\u003e\"\ngh secret set DEPLOY_USERNAME -b\"\u0026#x3C;DEPLOY_USERNAME\u003e\"\ngh secret set DEPLOY_KEY \u0026#x3C; key.pem # DEPLOY_KEY\ngh secret set LETSENCRYPT_EMAIL -b\"\u0026#x3C;LETSENCRYPT_EMAIL\u003e\"\ngh secret set DEPLOY_CDN -b\"\u0026#x3C;DEPLOY_CDN\u003e\"\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThese secrets are used to populate variables within GitHub Actions and other configuration files.\u003c/p\u003e\n\u003ch2\u003eUI Deployment\u003c/h2\u003e\n\u003cp\u003eThe Next.js \u003ccode\u003eui\u003c/code\u003e application is built and deployed to GitHub Pages during the \u003ccode\u003erelease.yml\u003c/code\u003e workflow process by committing the result of \u003ccode\u003enpm run build\u003c/code\u003e to \u003ccode\u003egh-pages\u003c/code\u003e branch in the repository.\u003c/p\u003e\n\u003cp\u003eVariable replacement of \u003ccode\u003e$DEPLOY_API\u003c/code\u003e and \u003ccode\u003e$DEPLOY_CDN\u003c/code\u003e is performed on the following files as a way to coordinate configuration between the \u003ccode\u003eui\u003c/code\u003e and \u003ccode\u003eapi\u003c/code\u003e project.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eui/next.config.js\u003c/code\u003e - Set backend .NET API URL for UI App to use\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eui/post.build.js\u003c/code\u003e - If exists, run from GitHub Action after \u003ccode\u003enpm run build\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3\u003epost.build.js\u003c/h3\u003e\n\u003cp\u003eThe \u003ccode\u003epost.build.js\u003c/code\u003e script helps when also publishing \u003ccode\u003e/ui\u003c/code\u003e assets to CDN by first copying the generated\n\u003ccode\u003eindex.html\u003c/code\u003e home page into \u003ccode\u003e404.html\u003c/code\u003e in order to enable full page reloads to use SPA client routing:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-js\"\u003econst fs = require(\"fs\")\nconst path = require(\"path\")\n\n// Replaced in release.yml with GitHub Actions secrets\nconst DEPLOY_API = 'https://$DEPLOY_API'\nconst DEPLOY_CDN = 'https://$DEPLOY_CDN'\n\nconst DIST = '../api/Jamstacks/wwwroot'\n\n// 404.html SPA fallback (supported by GitHub Pages, Cloudflare \u0026#x26; Netlify CDNs)\nfs.copyFileSync(\n    path.resolve(`${DIST}/index.html`),\n    path.resolve(`${DIST}/404.html`))\n\n// Define Virtual Host for GitHub Pages CDN\nfs.writeFileSync(`${DIST}/CNAME`, DEPLOY_CDN)\n\n// Define /api proxy routes (supported by Cloudflare or Netlify CDNs)  \nfs.writeFileSync(`${DIST}/_redirects`,\n    fs.readFileSync(`${DIST}/_redirects`, 'utf-8')\n        .replace(/{DEPLOY_API}/g, DEPLOY_API))\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWhilst the \u003ccode\u003e_redirects\u003c/code\u003e file is a convention supported by many \u003ca href=\"https://jamstack.wtf/#deployment\"\u003epopular Jamstack CDNs\u003c/a\u003e\nthat sets up a new rule that proxies \u003ccode\u003e/api*\u003c/code\u003e requests to where the production .NET App is deployed to in order\nfor API requests to not need CORS:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e/api/*  {DEPLOY_API}/api/:splat  200\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eBy default this template doesn't use the \u003ccode\u003e/api\u003c/code\u003e proxy route \u0026#x26; makes CORS API requests so it can be freely hosted\non GitHub pages CDN.\u003c/p\u003e\n\u003ch2\u003ePushing updates and rollbacks\u003c/h2\u003e\n\u003cp\u003eBy default, deployments of both the \u003ccode\u003eui\u003c/code\u003e and \u003ccode\u003eapi\u003c/code\u003e occur on commit to your main branch. A new Docker image for your ServiceStack API is produced, pushed to GHCR.io and hosted on your Linux server with Docker Compose.\nYour React UI is built and pushed to the repository GitHub Pages.\u003c/p\u003e\n\u003cp\u003eThe template also will run the release process on the creation of a GitHub Release making it easier to switch to manual production releases.\u003c/p\u003e\n\u003cp\u003eAdditionally, the \u003ccode\u003erelease.yml\u003c/code\u003e workflow can be run manually specifying a version. This enables production rollbacks based on previously tagged releases.\nA release must have already been created for the rollback build to work, it doesn't create a new Docker build based on previous code state, only redeploys as existing Docker image.\u003c/p\u003e\n\u003ch2\u003eNo CORS Hosting Options\u003c/h2\u003e\n\u003cp\u003eThe \u003ccode\u003eCorsFeature\u003c/code\u003e needs to be enabled when adopting our recommended deployment configuration of having static\n\u003ccode\u003e/wwwroot\u003c/code\u003e assets hosted from a CDN in order to make cross-domain requests to your .NET APIs.\u003c/p\u003e\n\u003ch3\u003eUsing a CDN Proxy\u003c/h3\u003e\n\u003cp\u003eShould you want to, our recommended approach to avoid your App making CORS requests is to define an \u003ccode\u003e/api\u003c/code\u003e proxy route\non your CDN to your \u003ccode\u003e$DEPLOY_API\u003c/code\u003e server.\u003c/p\u003e\n\u003cp\u003eTo better support this use-case, this template includes populating the \u003ccode\u003e_redirects\u003c/code\u003e file used by popular CDNs like\n\u003ca href=\"https://developers.cloudflare.com/pages/platform/redirects\"\u003eCloudflare proxy redirects\u003c/a\u003e and\n\u003ca href=\"https://docs.netlify.com/routing/redirects/rewrites-proxies/#proxy-to-another-service\"\u003eNetlify proxies\u003c/a\u003e to define\nredirect and proxy rules. For AWS CloudFront you would need to define a\n\u003ca href=\"https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/RequestAndResponseBehaviorCustomOrigin.html\"\u003eBehavior for a custom origin\u003c/a\u003e.\u003c/p\u003e\n\u003ch3\u003eNo CDN\u003c/h3\u003e\n\u003cp\u003eOf course the easiest solution is to not need CORS in the first place by not deploying to a CDN and serving both \u003ccode\u003e/api\u003c/code\u003e\nand UI from your .NET App. But this would forgo all the performance \u0026#x26; UX benefits that has made\n\u003ca href=\"https://jamstack.org\"\u003eJamstack\u003c/a\u003e approach so popular.\u003c/p\u003e","ogImage":{"url":"/assets/blog/dynamic-routing/cover.jpg"},"coverImage":"/assets/blog/dynamic-routing/cover.jpg"}},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"deploy"},"buildId":"4l-1YYj4UL_dqsszTxfpO","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>